version: '3.8'

services:
  # API Server service
  compiler-api:
    build:
      context: ..  # Build from repo root
      dockerfile: compiler/Dockerfile
    container_name: compiler-api
    ports:
      - "8000:8000"
    volumes:
      # Shared volume for template variations
      - template-variations:/tmp/selection
      # Shared volume for active project
      - active-project:/tmp/active
      # Mount server code for development (optional - remove in production)
      - ./server:/app/compiler/server
      - ./manifests:/app/compiler/manifests
      - ./server/templates:/app/compiler/server/templates
    environment:
      - PYTHONUNBUFFERED=1
      - HOST=0.0.0.0
      - PORT=8000
    networks:
      - compiler-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/project"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # Variations viewer service
  compiler-variations:
    build:
      context: ..  # Build from repo root
      dockerfile: compiler/Dockerfile.variations
    container_name: compiler-variations
    ports:
      - "5173:5173"  # Variation 0 - Professional
      - "5174:5174"  # Variation 1 - Dark
      - "5175:5175"  # Variation 2 - Minimal
      - "5176:5176"  # Variation 3 - Energetic
      - "5177:5177"  # Active project
    volumes:
      # Same shared volumes as API server
      - template-variations:/tmp/selection
      - active-project:/tmp/active
    environment:
      - NODE_ENV=development
    networks:
      - compiler-network
    depends_on:
      compiler-api:
        condition: service_healthy
    command: >
      bash -c "
        echo 'üöÄ Starting active project dev server on port 5177...';
        cd /tmp/active;
        if [ -f package.json ]; then
          npm install;
          npx vite --host 0.0.0.0 --port 5177 --strictPort &
          ACTIVE_PID=\$!;
          echo '‚úÖ Active project server started (PID: '\$ACTIVE_PID')';
        else
          echo '‚ö†Ô∏è  No package.json in /tmp/active, waiting for files...';
          while [ ! -f /tmp/active/package.json ]; do sleep 2; done;
          npm install;
          npx vite --host 0.0.0.0 --port 5177 --strictPort &
          ACTIVE_PID=\$!;
          echo '‚úÖ Active project server started (PID: '\$ACTIVE_PID')';
        fi;
        
        echo 'üì¶ Checking for template variations (optional)...';
        if [ -d /tmp/selection/0 ] && [ -f /tmp/selection/0/package.json ]; then
          echo '‚úÖ Variations found, starting variation servers...';
          /app/compiler/server/run_variations.sh &
        else
          echo '‚ÑπÔ∏è  No variations found, skipping variation servers';
        fi;
        
        wait \$ACTIVE_PID;
      "


networks:
  compiler-network:
    driver: bridge

volumes:
  template-variations:
    driver: local
  active-project:
    driver: local
