version: '3.8'

services:
  # API Server service
  compiler-api:
    build:
      context: ..  # Build from repo root
      dockerfile: compiler/Dockerfile
    container_name: compiler-api
    ports:
      - "8000:8000"
    volumes:
      # Shared volume for template variations
      - template-variations:/tmp/selection
      # Mount server code for development (optional - remove in production)
      - ./server:/app/compiler/server
      - ./manifests:/app/compiler/manifests
      - ./server/templates:/app/compiler/server/templates
    environment:
      - PYTHONUNBUFFERED=1
      - HOST=0.0.0.0
      - PORT=8000
    networks:
      - compiler-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/project"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # Variations viewer service (simplified - no active project, no restart)
  compiler-variations:
    build:
      context: ..  # Build from repo root
      dockerfile: compiler/Dockerfile.variations
    container_name: compiler-variations
    ports:
      - "5173:5173"  # Variation 0 - Professional
      - "5174:5174"  # Variation 1 - Dark
      - "5175:5175"  # Variation 2 - Minimal
      - "5176:5176"  # Variation 3 - Energetic
    volumes:
      # Shared volume for template variations (no more active-project)
      - template-variations:/tmp/selection
    environment:
      - NODE_ENV=development
    networks:
      - compiler-network
    depends_on:
      compiler-api:
        condition: service_healthy
    command: /app/compiler/server/run_variations.sh


networks:
  compiler-network:
    driver: bridge

volumes:
  template-variations:
    driver: local
